<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>图片浏览器</title>
    <style>
        /* CSS 布局 */
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            background: #333;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
        }

        #refreshBtn {
            padding: 8px 16px;
            margin-right: 20px;
            cursor: pointer;
        }

        #container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #fileTree {
            width: 300px;
            background: #f5f5f5;
            overflow-y: auto;
            padding: 10px;
            border-right: 1px solid #ddd;
        }

        #preview {
            flex: 1;
            padding: 20px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 文件树样式 */
        .tree-item {
            cursor: pointer;
            padding: 4px;
            user-select: none;
        }

        .tree-item:hover {
            background: #e0e0e0;
        }

        .folder::before {
            content: "📁 ";
        }

        .file::before {
            content: "📄 ";
        }

        .children {
            margin-left: 20px;
            display: none;
        }

        .expanded .children {
            display: block;
        }
    </style>
</head>
<body>
    <!-- 页眉 -->
    <div id="header">
        <button id="refreshBtn">刷新文件树</button>
        <h3>图片浏览器</h3>
    </div>

    <!-- 主体容器 -->
    <div id="container">
        <!-- 左侧文件树 -->
        <div id="fileTree"></div>

        <!-- 右侧图片预览 -->
        <div id="preview">
            <p>点击左侧文件树中的图片文件进行预览</p>
        </div>
    </div>

    <script>
        // 获取 DOM 元素
        const refreshBtn = document.getElementById('refreshBtn');
        const fileTree = document.getElementById('fileTree');
        const preview = document.getElementById('preview');

        // 处理目录选择与文件树生成
        async function loadDirectory() {
            try {
                // 请求用户选择目录
                const dirHandle = await window.showDirectoryPicker();
                fileTree.innerHTML = ''; // 清空旧文件树
                await buildFileTree(dirHandle, fileTree);
            } catch (err) {
                console.error('Error accessing directory:', err);
            }
        }

        // 递归构建文件树
        async function buildFileTree(dirHandle, parentElement) {
            const ul = document.createElement('ul');
            for await (const entry of dirHandle.values()) {
                const li = document.createElement('li');
                li.className = 'tree-item';
                
                if (entry.kind === 'directory') {
                    // 处理目录
                    li.innerHTML = `<div class="folder">${entry.name}</div>`;
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'children';
                    li.appendChild(childrenDiv);

                    // 点击目录展开/折叠
                    li.querySelector('.folder').addEventListener('click', (e) => {
                        e.stopPropagation();
                        li.classList.toggle('expanded');
                    });

                    // 递归子目录
                    await buildFileTree(entry, childrenDiv);
                } else if (entry.kind === 'file' && isImageFile(entry.name)) {
                    // 处理图片文件
                    li.innerHTML = `<div class="file">${entry.name}</div>`;
                    
                    // 点击文件预览图片
                    li.querySelector('.file').addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const file = await entry.getFile();
                        const url = URL.createObjectURL(file);
                        preview.innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 80vh;">`;
                    });
                }
                ul.appendChild(li);
            }
            parentElement.appendChild(ul);
        }

        // 判断是否为图片文件
        function isImageFile(filename) {
            return /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(filename);
        }

        // 刷新按钮点击事件
        refreshBtn.addEventListener('click', loadDirectory);

        // 初始化提示
        preview.innerHTML = '<p>请先点击"刷新文件树"按钮选择包含图片的目录</p>';
    </script>
</body>
</html>
